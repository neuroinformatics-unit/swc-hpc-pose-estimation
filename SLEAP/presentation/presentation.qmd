---
title: Pose estimation with SLEAP
subtitle: Applied HPC use example
author: Niko Sirmpilatze
format:
    revealjs:
        theme: [default, niu-light.scss]
        logo: img/logo_niu_light.png
        footer: "Introduction to HPC with Linux | 2023-05-15"
        slide-number: c
        menu:
            numbers: true
        chalkboard: true
        scrollable: true
        preview-links: false
        view-distance: 10
        mobile-view-distance: 10
        auto-animate: true
        auto-play-media: true
        code-overflow: wrap
        highlight-style: atom-one
---

## Outline

::: {.incremental}
- Pose estimation primer
- SLEAP pipeline showcase
  - Running a single training job on HPC
  - Batching multiple jobs
:::

## Tracking animals in videos {.smaller}

:::: {.columns}

::: {.column width="60%"}
![From: *Quantifying behavior to understand the brain, Nat Neuro 2020*](img/tracking_types.png){fig-align=center height=500}
:::

::::

## Pose estimation {.smaller}

![From: *Quantifying behavior to understand the brain, Nat Neuro 2020*](img/pose_estimation_2D.png){.r-stretch fig-align=left}

## Existing tools

:::: {.columns}

::: {.column width="35%"}
- [DeepLabCut](http://www.mackenziemathislab.org/deeplabcut)
- [SLEAP](https://sleap.ai/)
- Many others:
  - OpenPose
  - DeepPoseKit
  - Anipose
  - Freipose
  - ...
:::

::: {.column width="65%"}
![](img/sleap_movie.gif)
:::

::::

## SLEAP workflow

![](diagrams/pose-estimation.svg){fig-align=center height=150}

::: {.fragment}
- training and inference are GPU-intensive
- we can delegate to the HPC cluster's GPU nodes
:::

## Top-down vs bottom-up {.smaller}

![From: *Quantifying behavior to understand the brain, Nat Neuro 2020*](img/pose_estimation_topdown_vs_bottomup.png){fig-align=left height=500}

## Finding our project on the HPC

```{.bash code-line-numbers="1-3|5-8|10-12|14-15|"}
# Logging into the HPC cluster
ssh <SWC-USERNAME>@ssh.swc.ucl.ac.uk # Provide password
ssh hpc-gw1 # Provide password again

# Navigate to your SLEAP project
cd /ceph/neuroinformatics/neuroinformatics/sirmpilatzen/SLEAP_tutorial
# Check the contents of your folder
ls -l

# Go inside the exported training package
cd labels.v002.slp.training_job
ls -l

# View the contents of train-script.sh
cat train-script.sh
```
::: {.fragment}
`train-script.sh`

```{.bash}
#!/bin/bash
sleap-train centroid.json labels.v002.pkg.slp
sleap-train centered_instance.json labels.v002.pkg.slp
```
:::

## Get the code {.smaller}

```{.bash}
# Clone the GitHub repository
git clone https://github.com/neuroinformatics-unit/swc-hpc-pose-estimation.git

# View the contenrs of the SLURM script
cat swc-hpc-pose-estimation/SLEAP/slurm_batch_script.sh
```
::: {.fragment}
`slurm_batch_script.sh`

```{.bash code-line-numbers="1-12|13-21|"}
#!/bin/bash

#SBATCH -p gpu # partition (queue)
#SBATCH -N 1   # number of nodes
#SBATCH --mem 12G # memory pool for all cores
#SBATCH -n 2 # number of cores
#SBATCH -t 0-06:00 # time (D-HH:MM)
#SBATCH --gres gpu:1 # request 1 GPU (of any kind)
#SBATCH -o slurm_output.out
#SBATCH -e slurm_error.err
#SBATCH --mail-type=ALL
#SBATCH --mail-user=ucqfnsi@ucl.ac.uk

# Load the SLEAP module
module load SLEAP

# Go to the training job directory
cd /ceph/neuroinformatics/neuroinformatics/sirmpilatzen/SLEAP_tutorial/labels.v002.slp.training_job

# Run the training script generated by SLEAP
bash train-script.sh
```
:::

## Acknowledgements {.smaller}

* Loukia Katsouri (mouse videos)
* Chang Huan Lo (example SLEAP code)
* Alex Martin (setting up HPC modules)
* Sofia Minano and Laura Schwarz (testing)
